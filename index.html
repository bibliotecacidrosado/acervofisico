<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acervo Físico - Biblioteca Cid Rosado</title>
  <!-- Favicon adicionado aqui -->
  <link rel="icon" href="https://raw.githubusercontent.com/bibliotecacidrosado/acervofisico/refs/heads/main/favicon2.png" type="image/png">
  <style>
    :root {
      --cor-primaria: #ff8c00;
      --cor-secundaria: #ffb74d;
      --cor-texto: #333;
      --cor-fundo: #f5f5f5;
      --cor-borda: #ddd;
      --cor-disponivel: #2e7d32;
      --cor-indisponivel: #c62828;
      --cor-paginacao: #4285f4;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body { 
      font-family: Arial, sans-serif; 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 15px;
      background: var(--cor-fundo);
      color: var(--cor-texto);
      line-height: 1.5;
    }
    
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    h1 {
      background: var(--cor-primaria); 
      color: #fff; 
      padding: 15px; 
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 1.5rem;
    }
    
    .info-biblioteca {
      background: white;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 15px;
    }
    
    .resumo {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .resumo-item {
      text-align: center;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 6px;
    }
    
    .resumo-numero {
      font-size: 20px;
      font-weight: bold;
      color: var(--cor-primaria);
      margin-top: 5px;
    }
    
    #busca {
      width: 100%; 
      padding: 12px; 
      margin-bottom: 15px; 
      border-radius: 5px; 
      border: 1px solid var(--cor-borda); 
      font-size: 16px;
    }
    
    .filtros {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    select {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid var(--cor-borda);
      width: 100%;
    }
    
    .lista-container {
      border: 1px solid var(--cor-borda); 
      border-radius: 5px;
      background: white;
      margin-bottom: 20px;
      overflow-x: auto;
    }
    
    .cabecalho, .livro {
      display: grid; 
      grid-template-columns: 2fr 1.5fr 1fr 1.5fr 1.2fr;
      padding: 12px; 
      gap: 10px;
      min-width: 600px;
    }
    
    .cabecalho {
      background: var(--cor-secundaria); 
      font-weight: bold; 
      border-bottom: 2px solid var(--cor-primaria);
      cursor: pointer;
    }
    
    .cabecalho span:hover {
      color: var(--cor-primaria);
    }
    
    .cabecalho span.sorted-asc::after {
      content: " ▲";
      font-size: 0.8em;
    }
    
    .cabecalho span.sorted-desc::after {
      content: " ▼";
      font-size: 0.8em;
    }
    
    .livro:nth-child(odd) {background: #fff;}
    .livro:nth-child(even) {background: #f9f9f9;}
    .livro:hover {
      background: #f0f0f0;
    }
    
    .status {font-weight: bold;}
    .disponivel {color: var(--cor-disponivel);}
    .indisponivel {color: var(--cor-indisponivel);}
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      text-align: center;
    }
    
    .paginacao {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .paginacao button {
      padding: 8px 12px;
      background: white;
      border: 1px solid var(--cor-borda);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .paginacao button:hover:not(:disabled) {
      background: var(--cor-secundaria);
    }
    
    .paginacao button.active {
      background: var(--cor-paginacao);
      color: white;
      border-color: var(--cor-paginacao);
    }
    
    .paginacao button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .paginacao-info {
      margin: 0 10px;
      font-size: 14px;
    }
    
    .controles-adicionais {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .controles-adicionais select {
      width: auto;
      min-width: 150px;
    }
    
    .cache-info {
      font-size: 12px;
      color: #666;
      text-align: right;
      margin-top: 5px;
    }

    /* --- Versão Mobile --- */
    @media (max-width: 768px) {
      .resumo {
        grid-template-columns: 1fr;
      }
      
      .filtros {
        grid-template-columns: 1fr;
      }
      
      .cabecalho {
        display: none;
      }
      
      .livro {
        display: block; 
        padding: 15px;
        border-bottom: 1px solid #ddd;
        min-width: unset;
      }
      
      .livro > span {
        display: block;
        width: 100%;
        padding: 5px 0;
        margin-bottom: 5px;
      }
      
      .livro > span::before {
        font-weight: bold;
        color: #333;
        display: inline-block;
        width: 100px;
        content: attr(data-label);
      }
      
      .lista-container {
        overflow-x: visible;
      }
      
      .controles-adicionais {
        flex-direction: column;
        align-items: stretch;
      }
      
      .controles-adicionais select {
        width: 100%;
      }
      
      .paginacao {
        flex-direction: column;
        gap: 5px;
      }
      
      .paginacao .grupo-botoes {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Acervo Físico - Biblioteca Cid Rosado</h1>
    <div class="info-biblioteca">
      <p>Atualizado automaticamente a partir do Google Sheets</p>
    </div>
  </header>
  
  <div class="resumo" id="resumo">
    <div class="resumo-item">
      <div>Total de livros</div>
      <div class="resumo-numero" id="total-livros">0</div>
    </div>
    <div class="resumo-item">
      <div>Disponíveis</div>
      <div class="resumo-numero" id="total-disponiveis">0</div>
    </div>
  </div>
  
  <div id="mensagem"></div>
  
  <input type="text" id="busca" placeholder="Buscar por título, autor, gênero ou localização..." oninput="filtrarLivros()">

  <div class="filtros">
    <div>
      <select id="filtroStatus" onchange="filtrarLivros()">
        <option value="todos">Todos os status</option>
        <option value="Disponível">Disponível</option>
        <option value="Indisponível">Indisponível</option>
      </select>
    </div>
    <div>
      <select id="filtroGenero" onchange="filtrarLivros()">
        <option value="todos">Todos os gêneros</option>
        <!-- Opções serão preenchidas dinamicamente -->
      </select>
    </div>
  </div>
  
  <div class="controles-adicionais">
    <div>
      <label for="itensPorPagina">Itens por página: </label>
      <select id="itensPorPagina" onchange="mudarItensPorPagina()">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </div>
    <div class="cache-info" id="cache-info">
      <!-- Informações do cache serão preenchidas aqui -->
    </div>
  </div>

  <div class="lista-container">
    <!-- Cabeçalho da lista -->
    <div class="cabecalho">
      <span onclick="ordenarPor('titulo')">Título</span>
      <span onclick="ordenarPor('autor')">Autor</span>
      <span onclick="ordenarPor('genero')">Gênero</span>
      <span onclick="ordenarPor('localizacao')">Localização</span>
      <span onclick="ordenarPor('status')">Status</span>
    </div>
    <div id="listaLivros">
      <div class="loading" id="loading-message">
        <p>Carregando acervo...</p>
      </div>
    </div>
  </div>
  
  <div class="paginacao" id="paginacao">
    <!-- A paginação será gerada aqui dinamicamente -->
  </div>

  <script>
    // URL do arquivo JSON no GitHub
    const URL_JSON = 'https://raw.githubusercontent.com/bibliotecacidrosado/acervofisico/refs/heads/main/dados.json';
    const CACHE_KEY = 'biblioteca_acervo_cache';
    const CACHE_TIMESTAMP_KEY = 'biblioteca_acervo_timestamp';
    const CACHE_DURATION = 30 * 60 * 1000; // 30 minutos em milissegundos
    
    let livrosAcervo = [];
    let dadosCompletos = [];
    let generosDisponiveis = [];
    let livrosFiltrados = [];
    
    // Configurações de paginação
    let paginaAtual = 1;
    let itensPorPagina = 20;
    let ordenacao = {
      campo: 'titulo',
      direcao: 'asc'
    };

    function mostrarMensagem(texto, tipo) {
      const mensagemDiv = document.getElementById('mensagem');
      mensagemDiv.innerHTML = `<div class="${tipo}">${texto}</div>`;
      
      if (tipo !== 'error') {
        setTimeout(() => {
          mensagemDiv.innerHTML = '';
        }, 3000);
      }
    }

    function atualizarResumo(dados) {
      const totalLivros = dados.length || 0;
      const totalDisponiveis = dados.filter(l => l.status === 'Disponível').length || 0;
      
      document.getElementById('total-livros').textContent = totalLivros;
      document.getElementById('total-disponiveis').textContent = totalDisponiveis;
    }

    function atualizarLista(dados) {
      const lista = document.getElementById('listaLivros');
      
      // Atualizar resumo
      atualizarResumo(dadosCompletos);
      
      // Limpar lista
      lista.innerHTML = '';
      
      // Verificar se há livros para mostrar
      if (!dados || dados.length === 0) {
        lista.innerHTML = '<div class="loading">Nenhum livro encontrado</div>';
        return;
      }
      
      // Calcular índices para paginação
      const inicio = (paginaAtual - 1) * itensPorPagina;
      const fim = inicio + itensPorPagina;
      const livrosPagina = dados.slice(inicio, fim);
      
      // Adicionar livros à lista
      livrosPagina.forEach(l => {
        const div = document.createElement('div');
        div.className = 'livro';
        
        // Preparar para mobile - adicionar atributos data-label
        if (window.innerWidth <= 768) {
          div.innerHTML = `
            <span data-label="Título: ">${l.titulo || 'Não informado'}</span>
            <span data-label="Autor: ">${l.autor || 'Não informado'}</span>
            <span data-label="Gênero: ">${l.genero || 'Não informado'}</span>
            <span data-label="Localização: ">${l.localizacao || 'Não informado'}</span>
            <span data-label="Status: " class="status ${l.status === 'Disponível' ? 'disponivel' : 'indisponivel'}">
              ${l.disponiveis > 0 ? `${l.disponiveis} exemplar(es) ${l.status}` : l.status}
            </span>`;
        } else {
          div.innerHTML = `
            <span>${l.titulo || 'Não informado'}</span>
            <span>${l.autor || 'Não informado'}</span>
            <span>${l.genero || 'Não informado'}</span>
            <span>${l.localizacao || 'Não informado'}</span>
            <span class="status ${l.status === 'Disponível' ? 'disponivel' : 'indisponivel'}">
              ${l.disponiveis > 0 ? `${l.disponiveis} exemplar(es) ${l.status}` : l.status}
            </span>`;
        }
        
        lista.appendChild(div);
      });
      
      // Atualizar controles de paginação
      atualizarPaginacao(dados.length);
    }

    function atualizarPaginacao(totalItens) {
      const totalPaginas = Math.ceil(totalItens / itensPorPagina);
      const paginacaoDiv = document.getElementById('paginacao');
      
      // Limpar paginação existente
      paginacaoDiv.innerHTML = '';
      
      if (totalPaginas <= 1) return;
      
      // Botão anterior
      const btnAnterior = document.createElement('button');
      btnAnterior.innerHTML = '&laquo; Anterior';
      btnAnterior.disabled = paginaAtual === 1;
      btnAnterior.addEventListener('click', () => {
        if (paginaAtual > 1) {
          paginaAtual--;
          atualizarLista(livrosFiltrados);
        }
      });
      paginacaoDiv.appendChild(btnAnterior);
      
      // Grupo de botões de página
      const grupoBotoes = document.createElement('div');
      grupoBotoes.className = 'grupo-botoes';
      
      // Calcular range de páginas para mostrar
      let inicioPaginas = Math.max(1, paginaAtual - 2);
      let fimPaginas = Math.min(totalPaginas, paginaAtual + 2);
      
      // Ajustar se estiver no início
      if (paginaAtual <= 3) {
        fimPaginas = Math.min(totalPaginas, 5);
      }
      
      // Ajustar se estiver no final
      if (paginaAtual >= totalPaginas - 2) {
        inicioPaginas = Math.max(1, totalPaginas - 4);
      }
      
      // Botão primeira página
      if (inicioPaginas > 1) {
        const btnPrimeira = document.createElement('button');
        btnPrimeira.textContent = '1';
        btnPrimeira.addEventListener('click', () => {
          paginaAtual = 1;
          atualizarLista(livrosFiltrados);
        });
        grupoBotoes.appendChild(btnPrimeira);
        
        if (inicioPaginas > 2) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.style.padding = '0 5px';
          grupoBotoes.appendChild(ellipsis);
        }
      }
      
      // Botões de página numéricos
      for (let i = inicioPaginas; i <= fimPaginas; i++) {
        const btnPagina = document.createElement('button');
        btnPagina.textContent = i;
        btnPagina.classList.toggle('active', i === paginaAtual);
        btnPagina.addEventListener('click', () => {
          paginaAtual = i;
          atualizarLista(livrosFiltrados);
        });
        grupoBotoes.appendChild(btnPagina);
      }
      
      // Botão última página
      if (fimPaginas < totalPaginas) {
        if (fimPaginas < totalPaginas - 1) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.style.padding = '0 5px';
          grupoBotoes.appendChild(ellipsis);
        }
        
        const btnUltima = document.createElement('button');
        btnUltima.textContent = totalPaginas;
        btnUltima.addEventListener('click', () => {
          paginaAtual = totalPaginas;
          atualizarLista(livrosFiltrados);
        });
        grupoBotoes.appendChild(btnUltima);
      }
      
      paginacaoDiv.appendChild(grupoBotoes);
      
      // Botão próximo
      const btnProximo = document.createElement('button');
      btnProximo.innerHTML = 'Próximo &raquo;';
      btnProximo.disabled = paginaAtual === totalPaginas;
      btnProximo.addEventListener('click', () => {
        if (paginaAtual < totalPaginas) {
          paginaAtual++;
          atualizarLista(livrosFiltrados);
        }
      });
      paginacaoDiv.appendChild(btnProximo);
      
      // Informação de página atual
      const infoPagina = document.createElement('div');
      infoPagina.className = 'paginacao-info';
      infoPagina.textContent = `Página ${paginaAtual} de ${totalPaginas} - ${totalItens} itens`;
      paginacaoDiv.appendChild(infoPagina);
    }

    function extrairGeneros() {
      const generosSet = new Set();
      dadosCompletos.forEach(livro => {
        const genero = String(livro.genero || '').trim();
        if (genero !== '') {
          generosSet.add(genero);
        }
      });
      
      generosDisponiveis = Array.from(generosSet).sort();
      
      const filtroGenero = document.getElementById('filtroGenero');
      // Manter a primeira opção ("Todos os gêneros")
      while (filtroGenero.options.length > 1) {
        filtroGenero.remove(1);
      }
      
      // Adicionar os gêneros extraídos
      generosDisponiveis.forEach(genero => {
        const option = document.createElement('option');
        option.value = genero;
        option.textContent = genero;
        filtroGenero.appendChild(option);
      });
    }

    function ordenarPor(campo) {
      // Se já está ordenando por este campo, inverter a direção
      if (ordenacao.campo === campo) {
        ordenacao.direcao = ordenacao.direcao === 'asc' ? 'desc' : 'asc';
      } else {
        // Se é um campo novo, ordenar asc por padrão
        ordenacao.campo = campo;
        ordenacao.direcao = 'asc';
      }
      
      // Atualizar indicadores visuais nos cabeçalhos
      const cabecalhos = document.querySelectorAll('.cabecalho span');
      cabecalhos.forEach(span => {
        span.classList.remove('sorted-asc', 'sorted-desc');
        if (span.textContent.replace(/[▲▼]/g, '').trim() === 
            document.querySelector(`.cabecalho span[onclick="ordenarPor('${campo}')"]`).textContent.replace(/[▲▼]/g, '').trim()) {
          span.classList.add(ordenacao.direcao === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
      });
      
      // Aplicar ordenação
      aplicarOrdenacao();
    }

    function aplicarOrdenacao() {
      livrosFiltrados.sort((a, b) => {
        // Garantir que os valores sejam strings antes de comparar
        let valorA = String(a[ordenacao.campo] || '').toLowerCase();
        let valorB = String(b[ordenacao.campo] || '').toLowerCase();
        
        if (valorA < valorB) return ordenacao.direcao === 'asc' ? -1 : 1;
        if (valorA > valorB) return ordenacao.direcao === 'asc' ? 1 : -1;
        return 0;
      });
      
      // Resetar para a primeira página após ordenação
      paginaAtual = 1;
      atualizarLista(livrosFiltrados);
    }

    function filtrarLivros(){
      console.log('Executando filtro...'); // Debug
      
      // Verificar se há dados para filtrar
      if (!dadosCompletos || dadosCompletos.length === 0) {
        console.log('Nenhum dado disponível para filtrar');
        return;
      }
      
      const termo = document.getElementById('busca').value.toLowerCase();
      const statusFiltro = document.getElementById('filtroStatus').value;
      const generoFiltro = document.getElementById('filtroGenero').value;
      
      console.log(`Filtrando: "${termo}", status: ${statusFiltro}, gênero: ${generoFiltro}`); // Debug
      
      livrosFiltrados = dadosCompletos.filter(l => {
        try {
          // Converter todos os campos para string de forma segura
          const titulo = String(l.titulo || '').toLowerCase();
          const autor = String(l.autor || '').toLowerCase();
          const genero = String(l.genero || '').toLowerCase();
          const localizacao = String(l.localizacao || '').toLowerCase();
          
          // Filtro por termo de busca
          const correspondeTermo = 
            titulo.includes(termo) ||
            autor.includes(termo) ||
            genero.includes(termo) ||
            localizacao.includes(termo);
          
          // Filtro por status
          const correspondeStatus = statusFiltro === 'todos' || l.status === statusFiltro;
          
          // Filtro por gênero
          const correspondeGenero = generoFiltro === 'todos' || l.genero === generoFiltro;
          
          return correspondeTermo && correspondeStatus && correspondeGenero;
        } catch (error) {
          console.error('Erro ao filtrar livro:', l, error);
          return false; // Excluir livros com erro da filtragem
        }
      });

      console.log(`Filtro concluído: ${livrosFiltrados.length} livros encontrados`); // Debug
      
      // Aplicar ordenação atual aos resultados filtrados
      aplicarOrdenacao();
    }

    function mudarItensPorPagina() {
      itensPorPagina = parseInt(document.getElementById('itensPorPagina').value);
      paginaAtual = 1; // Reset para a primeira página
      atualizarLista(livrosFiltrados);
    }

    function salvarNoCache(dados) {
      try {
        const timestamp = new Date().getTime();
        localStorage.setItem(CACHE_KEY, JSON.stringify(dados));
        localStorage.setItem(CACHE_TIMESTAMP_KEY, timestamp.toString());
        atualizarInfoCache(timestamp);
      } catch (e) {
        console.warn('Não foi possível salvar no cache (localStorage pode estar desabilitado ou cheio)', e);
      }
    }

    function obterDoCache() {
      try {
        const cachedData = localStorage.getItem(CACHE_KEY);
        const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
        
        if (cachedData && cachedTimestamp) {
          const timestamp = parseInt(cachedTimestamp);
          const agora = new Date().getTime();
          
          // Verificar se o cache ainda é válido
          if (agora - timestamp < CACHE_DURATION) {
            atualizarInfoCache(timestamp);
            return JSON.parse(cachedData);
          }
        }
      } catch (e) {
        console.warn('Erro ao acessar cache', e);
      }
      return null;
    }

    function atualizarInfoCache(timestamp) {
      const cacheInfoDiv = document.getElementById('cache-info');
      if (timestamp) {
        const data = new Date(timestamp);
        cacheInfoDiv.textContent = `Dados atualizados: ${data.toLocaleTimeString()}`;
      } else {
        cacheInfoDiv.textContent = '';
      }
    }

    async function carregarDados() {
      try {
        mostrarMensagem('Carregando dados do acervo...', 'loading');
        
        // Primeiro tentar obter do cache
        const cachedData = obterDoCache();
        if (cachedData) {
          dadosCompletos = cachedData.livros;
          livrosAcervo = [...dadosCompletos];
          livrosFiltrados = [...dadosCompletos];
          
          // Extrair gêneros únicos para o filtro
          extrairGeneros();
          
          // Aplicar ordenação padrão
          aplicarOrdenacao();
          
          mostrarMensagem('Dados carregados do cache!', 'success');
          return;
        }
        
        // Se não há cache válido, buscar da API
        const response = await fetch(URL_JSON);
        
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const dados = await response.json();
        
        // Verificar se os dados têm a estrutura esperada
        if (!dados.livros || !Array.isArray(dados.livros)) {
          throw new Error('Formato inválido do arquivo JSON. Esperada propriedade "livros" com array.');
        }
        
        dadosCompletos = dados.livros;
        livrosAcervo = [...dadosCompletos];
        livrosFiltrados = [...dadosCompletos];
        
        // Salvar no cache para uso futuro
        salvarNoCache(dados);
        
        // Extrair gêneros únicos para o filtro
        extrairGeneros();
        
        // Aplicar ordenação padrão
        aplicarOrdenacao();
        
        mostrarMensagem('Dados carregados com sucesso!', 'success');
        
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        mostrarMensagem(`Erro ao carregar dados: ${error.message}`, 'error');
        document.getElementById('listaLivros').innerHTML = 
          '<div class="error">Erro ao carregar o acervo. Verifique o console para detalhes.</div>';
      }
    }

    // Carregar dados automaticamente ao abrir a página
    document.addEventListener('DOMContentLoaded', function() {
      carregarDados();
      document.getElementById('busca').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          filtrarLivros();
        }
      });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acervo Físico - Biblioteca Cid Rosado</title>
  <style>
    :root {
      --cor-primaria: #ff8c00;
      --cor-secundaria: #ffb74d;
      --cor-texto: #333;
      --cor-fundo: #f5f5f5;
      --cor-borda: #ddd;
      --cor-disponivel: #2e7d32;
      --cor-indisponivel: #c62828;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body { 
      font-family: Arial, sans-serif; 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 15px;
      background: var(--cor-fundo);
      color: var(--cor-texto);
      line-height: 1.5;
    }
    
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    h1 {
      background: var(--cor-primaria); 
      color: #fff; 
      padding: 15px; 
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 1.5rem;
    }
    
    .info-biblioteca {
      background: white;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 15px;
    }
    
    .resumo {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .resumo-item {
      text-align: center;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 6px;
    }
    
    .resumo-numero {
      font-size: 20px;
      font-weight: bold;
      color: var(--cor-primaria);
      margin-top: 5px;
    }
    
    #busca {
      width: 100%; 
      padding: 12px; 
      margin-bottom: 15px; 
      border-radius: 5px; 
      border: 1px solid var(--cor-borda); 
      font-size: 16px;
    }
    
    .filtros {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    select {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid var(--cor-borda);
      width: 100%;
    }
    
    .lista-container {
      border: 1px solid var(--cor-borda); 
      border-radius: 5px;
      background: white;
      margin-bottom: 20px;
      overflow-x: auto;
    }
    
    .cabecalho, .livro {
      display: grid; 
      grid-template-columns: 2fr 1.5fr 1fr 1.5fr 1.2fr;
      padding: 12px; 
      gap: 10px;
      min-width: 600px;
    }
    
    .cabecalho {
      background: var(--cor-secundaria); 
      font-weight: bold; 
      border-bottom: 2px solid var(--cor-primaria);
    }
    
    .livro:nth-child(odd) {background: #fff;}
    .livro:nth-child(even) {background: #f9f9f9;}
    .livro:hover {
      background: #f0f0f0;
    }
    
    .status {font-weight: bold;}
    .disponivel {color: var(--cor-disponivel);}
    .indisponivel {color: var(--cor-indisponivel);}
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      text-align: center;
    }

    /* --- Versão Mobile --- */
    @media (max-width: 768px) {
      .resumo {
        grid-template-columns: 1fr;
      }
      
      .filtros {
        grid-template-columns: 1fr;
      }
      
      .cabecalho {
        display: none;
      }
      
      .livro {
        display: block; 
        padding: 15px;
        border-bottom: 1px solid #ddd;
        min-width: unset;
      }
      
      .livro > span {
        display: block;
        width: 100%;
        padding: 5px 0;
        margin-bottom: 5px;
      }
      
      .livro > span::before {
        font-weight: bold;
        color: #333;
        display: inline-block;
        width: 100px;
        content: attr(data-label);
      }
      
      .lista-container {
        overflow-x: visible;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Acervo Físico - Biblioteca Cid Rosado</h1>
    <div class="info-biblioteca">
      <p>Atualizado automaticamente a partir do Google Sheets</p>
    </div>
  </header>
  
  <div class="resumo" id="resumo">
    <div class="resumo-item">
      <div>Total de livros</div>
      <div class="resumo-numero" id="total-livros">0</div>
    </div>
    <div class="resumo-item">
      <div>Disponíveis</div>
      <div class="resumo-numero" id="total-disponiveis">0</div>
    </div>
  </div>
  
  <div id="mensagem"></div>
  
  <input type="text" id="busca" placeholder="Buscar por título, autor, gênero ou localização..." oninput="filtrarLivros()">

  <div class="filtros">
    <div>
      <select id="filtroStatus" onchange="filtrarLivros()">
        <option value="todos">Todos os status</option>
        <option value="Disponível">Disponível</option>
        <option value="Indisponível">Indisponível</option>
      </select>
    </div>
    <div>
      <select id="filtroGenero" onchange="filtrarLivros()">
        <option value="todos">Todos os gêneros</option>
        <!-- Opções serão preenchidas dinamicamente -->
      </select>
    </div>
  </div>

  <div class="lista-container">
    <!-- Cabeçalho da lista -->
    <div class="cabecalho">
      <span>Título</span>
      <span>Autor</span>
      <span>Gênero</span>
      <span>Localização</span>
      <span>Status</span>
    </div>
    <div id="listaLivros">
      <div class="loading" id="loading-message">
        <p>Carregando acervo...</p>
      </div>
    </div>
  </div>

  <script>
    // URL do arquivo JSON no GitHub
    const URL_JSON = 'https://raw.githubusercontent.com/bibliotecacidrosado/acervofisico/refs/heads/main/dados.json';
    
    let livrosAcervo = [];
    let dadosCompletos = [];
    let generosDisponiveis = [];

    function mostrarMensagem(texto, tipo) {
      const mensagemDiv = document.getElementById('mensagem');
      mensagemDiv.innerHTML = `<div class="${tipo}">${texto}</div>`;
      
      if (tipo !== 'error') {
        setTimeout(() => {
          mensagemDiv.innerHTML = '';
        }, 3000);
      }
    }

    function atualizarResumo(dados) {
      const totalLivros = dados.livros?.length || 0;
      const totalDisponiveis = dados.livros?.filter(l => l.status === 'Disponível').length || 0;
      
      document.getElementById('total-livros').textContent = totalLivros;
      document.getElementById('total-disponiveis').textContent = totalDisponiveis;
    }

    function atualizarLista(dados) {
      const lista = document.getElementById('listaLivros');
      
      // Atualizar resumo
      atualizarResumo(dados);
      
      // Limpar lista
      lista.innerHTML = '';
      
      // Verificar se há livros para mostrar
      if (!dados.livros || dados.livros.length === 0) {
        lista.innerHTML = '<div class="loading">Nenhum livro encontrado</div>';
        return;
      }
      
      // Adicionar livros à lista
      dados.livros.forEach(l => {
        const div = document.createElement('div');
        div.className = 'livro';
        
        // Preparar para mobile - adicionar atributos data-label
        if (window.innerWidth <= 768) {
          div.innerHTML = `
            <span data-label="Título: ">${l.titulo || 'Não informado'}</span>
            <span data-label="Autor: ">${l.autor || 'Não informado'}</span>
            <span data-label="Gênero: ">${l.genero || 'Não informado'}</span>
            <span data-label="Localização: ">${l.localizacao || 'Não informado'}</span>
            <span data-label="Status: " class="status ${l.status === 'Disponível' ? 'disponivel' : 'indisponivel'}">
              ${l.disponiveis > 0 ? `${l.disponiveis} exemplar(es) ${l.status}` : l.status}
            </span>`;
        } else {
          div.innerHTML = `
            <span>${l.titulo || 'Não informado'}</span>
            <span>${l.autor || 'Não informado'}</span>
            <span>${l.genero || 'Não informado'}</span>
            <span>${l.localizacao || 'Não informado'}</span>
            <span class="status ${l.status === 'Disponível' ? 'disponivel' : 'indisponivel'}">
              ${l.disponiveis > 0 ? `${l.disponiveis} exemplar(es) ${l.status}` : l.status}
            </span>`;
        }
        
        lista.appendChild(div);
      });
    }

    function extrairGeneros() {
      const generosSet = new Set();
      dadosCompletos.forEach(livro => {
        if (livro.genero && livro.genero.trim() !== '') {
          generosSet.add(livro.genero);
        }
      });
      
      generosDisponiveis = Array.from(generosSet).sort();
      
      const filtroGenero = document.getElementById('filtroGenero');
      // Manter a primeira opção ("Todos os gêneros")
      while (filtroGenero.options.length > 1) {
        filtroGenero.remove(1);
      }
      
      // Adicionar os gêneros extraídos
      generosDisponiveis.forEach(genero => {
        const option = document.createElement('option');
        option.value = genero;
        option.textContent = genero;
        filtroGenero.appendChild(option);
      });
    }

    function filtrarLivros(){
      const termo = document.getElementById('busca').value.toLowerCase();
      const statusFiltro = document.getElementById('filtroStatus').value;
      const generoFiltro = document.getElementById('filtroGenero').value;
      
      const listaFiltrada = dadosCompletos.filter(l => {
        // Filtro por termo de busca
        const correspondeTermo = 
          (l.titulo && l.titulo.toLowerCase().includes(termo)) ||
          (l.autor && l.autor.toLowerCase().includes(termo)) ||
          (l.genero && l.genero.toLowerCase().includes(termo)) ||
          (l.localizacao && l.localizacao.toLowerCase().includes(termo));
        
        // Filtro por status
        const correspondeStatus = statusFiltro === 'todos' || l.status === statusFiltro;
        
        // Filtro por gênero
        const correspondeGenero = generoFiltro === 'todos' || l.genero === generoFiltro;
        
        return correspondeTermo && correspondeStatus && correspondeGenero;
      });

      atualizarLista({
        livros: listaFiltrada
      });
    }

    async function carregarDados() {
      try {
        mostrarMensagem('Carregando dados do acervo...', 'loading');
        
        const response = await fetch(URL_JSON);
        
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const dados = await response.json();
        
        // Verificar se os dados têm a estrutura esperada
        if (!dados.livros || !Array.isArray(dados.livros)) {
          throw new Error('Formato inválido do arquivo JSON. Esperada propriedade "livros" com array.');
        }
        
        dadosCompletos = dados.livros;
        livrosAcervo = [...dadosCompletos];
        
        // Extrair gêneros únicos para o filtro
        extrairGeneros();
        
        // Preencher a lista de livros
        atualizarLista(dados);
        
        mostrarMensagem('Dados carregados com sucesso!', 'success');
        
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        mostrarMensagem(`Erro ao carregar dados: ${error.message}`, 'error');
        document.getElementById('listaLivros').innerHTML = 
          '<div class="error">Erro ao carregar o acervo. Verifique o console para detalhes.</div>';
      }
    }

    // Carregar dados automaticamente ao abrir a página
    document.addEventListener('DOMContentLoaded', function() {
      carregarDados();
      document.getElementById('busca').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          filtrarLivros();
        }
      });
    });
  </script>

<script>
// ========================== CONFIGURAÇÕES ========================== //
const URL_JSON = 'https://raw.githubusercontent.com/bibliotecacidrosado/acervofisico/refs/heads/main/dados.json';
const CACHE_KEY = 'biblioteca_acervo_cache';
const CACHE_TIMESTAMP_KEY = 'biblioteca_acervo_timestamp';
const CACHE_DURATION = 30 * 60 * 1000; // 30 minutos

// Configurações de paginação
const PAGINACAO_CONFIG = {
  itensPorPagina: 20,
  paginaAtual: 1,
  totalPaginas: 1,
  maxPaginasVisiveis: 5
};

let dadosCompletos = [];
let livrosFiltrados = [];

// ========================== CACHE ========================== //
function isCacheValid() {
  const timestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
  if (!timestamp) return false;
  const now = new Date().getTime();
  return (now - parseInt(timestamp)) < CACHE_DURATION;
}
function salvarNoCache(dados) {
  localStorage.setItem(CACHE_KEY, JSON.stringify(dados));
  localStorage.setItem(CACHE_TIMESTAMP_KEY, new Date().getTime().toString());
}
function recuperarDoCache() {
  const cachedData = localStorage.getItem(CACHE_KEY);
  return cachedData ? JSON.parse(cachedData) : null;
}

// ========================== PAGINAÇÃO ========================== //
function calcularTotalPaginas() {
  PAGINACAO_CONFIG.totalPaginas = Math.ceil(livrosFiltrados.length / PAGINACAO_CONFIG.itensPorPagina);
  PAGINACAO_CONFIG.totalPaginas = Math.max(PAGINACAO_CONFIG.totalPaginas, 1);
}
function irParaPagina(pagina) {
  if (pagina < 1 || pagina > PAGINACAO_CONFIG.totalPaginas) return;
  PAGINACAO_CONFIG.paginaAtual = pagina;
  renderizarLivros();
  atualizarControlesPaginacao();
  document.querySelector('.lista-container').scrollIntoView({ behavior: 'smooth' });
}
function atualizarControlesPaginacao() {
  const paginacao = document.getElementById('paginacao');
  paginacao.innerHTML = '';

  const controles = document.createElement('div');
  controles.className = 'controles-paginacao';

  // Botões
  const btnPrimeira = document.createElement('button');
  btnPrimeira.textContent = '«';
  btnPrimeira.disabled = PAGINACAO_CONFIG.paginaAtual === 1;
  btnPrimeira.onclick = () => irParaPagina(1);

  const btnAnterior = document.createElement('button');
  btnAnterior.textContent = '‹';
  btnAnterior.disabled = PAGINACAO_CONFIG.paginaAtual === 1;
  btnAnterior.onclick = () => irParaPagina(PAGINACAO_CONFIG.paginaAtual - 1);

  const btnProxima = document.createElement('button');
  btnProxima.textContent = '›';
  btnProxima.disabled = PAGINACAO_CONFIG.paginaAtual === PAGINACAO_CONFIG.totalPaginas;
  btnProxima.onclick = () => irParaPagina(PAGINACAO_CONFIG.paginaAtual + 1);

  const btnUltima = document.createElement('button');
  btnUltima.textContent = '»';
  btnUltima.disabled = PAGINACAO_CONFIG.paginaAtual === PAGINACAO_CONFIG.totalPaginas;
  btnUltima.onclick = () => irParaPagina(PAGINACAO_CONFIG.totalPaginas);

  // Números das páginas
  const numeros = document.createElement('div');
  numeros.className = 'numeros-paginas';
  let inicio = Math.max(1, PAGINACAO_CONFIG.paginaAtual - Math.floor(PAGINACAO_CONFIG.maxPaginasVisiveis/2));
  let fim = Math.min(PAGINACAO_CONFIG.totalPaginas, inicio + PAGINACAO_CONFIG.maxPaginasVisiveis - 1);
  if (fim - inicio + 1 < PAGINACAO_CONFIG.maxPaginasVisiveis) {
    inicio = Math.max(1, fim - PAGINACAO_CONFIG.maxPaginasVisiveis + 1);
  }
  for (let i = inicio; i <= fim; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    if (i === PAGINACAO_CONFIG.paginaAtual) btn.classList.add('ativo');
    btn.onclick = () => irParaPagina(i);
    numeros.appendChild(btn);
  }

  // Campo salto
  const saltoDiv = document.createElement('div');
  saltoDiv.className = 'salto-pagina';
  const input = document.createElement('input');
  input.type = 'number';
  input.min = 1;
  input.max = PAGINACAO_CONFIG.totalPaginas;
  input.placeholder = 'Página';
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const val = parseInt(input.value);
      if (!isNaN(val)) irParaPagina(val);
    }
  });
  const btnIr = document.createElement('button');
  btnIr.textContent = 'Ir';
  btnIr.onclick = () => {
    const val = parseInt(input.value);
    if (!isNaN(val)) irParaPagina(val);
  };
  saltoDiv.appendChild(input);
  saltoDiv.appendChild(btnIr);

  // Select itens por página
  const select = document.createElement('select');
  [10,20,50,100].forEach(num => {
    const opt = document.createElement('option');
    opt.value = num;
    opt.textContent = num + ' por página';
    if (num === PAGINACAO_CONFIG.itensPorPagina) opt.selected = true;
    select.appendChild(opt);
  });
  select.onchange = () => {
    PAGINACAO_CONFIG.itensPorPagina = parseInt(select.value);
    PAGINACAO_CONFIG.paginaAtual = 1;
    calcularTotalPaginas();
    renderizarLivros();
    atualizarControlesPaginacao();
  };

  // Montagem
  controles.appendChild(btnPrimeira);
  controles.appendChild(btnAnterior);
  controles.appendChild(numeros);
  controles.appendChild(btnProxima);
  controles.appendChild(btnUltima);
  controles.appendChild(saltoDiv);
  controles.appendChild(select);
  paginacao.appendChild(controles);

  // Info
  const info = document.createElement('div');
  info.className = 'paginacao-info';
  const inicioReg = (PAGINACAO_CONFIG.paginaAtual - 1) * PAGINACAO_CONFIG.itensPorPagina + 1;
  const fimReg = Math.min(PAGINACAO_CONFIG.paginaAtual * PAGINACAO_CONFIG.itensPorPagina, livrosFiltrados.length);
  info.textContent = `Mostrando ${inicioReg}-${fimReg} de ${livrosFiltrados.length}`;
  paginacao.appendChild(info);
}

// ========================== RENDERIZAÇÃO ========================== //
function renderizarLivros() {
  const lista = document.getElementById('listaLivros');
  lista.innerHTML = '';
  if (!livrosFiltrados.length) {
    lista.innerHTML = '<div class="loading">Nenhum livro encontrado</div>';
    return;
  }
  const inicio = (PAGINACAO_CONFIG.paginaAtual - 1) * PAGINACAO_CONFIG.itensPorPagina;
  const fim = inicio + PAGINACAO_CONFIG.itensPorPagina;
  const livrosPagina = livrosFiltrados.slice(inicio, fim);
  livrosPagina.forEach(l => {
    const div = document.createElement('div');
    div.className = 'livro';
    div.innerHTML = `
      <span>${l.titulo || 'Não informado'}</span>
      <span>${l.autor || 'Não informado'}</span>
      <span>${l.genero || 'Não informado'}</span>
      <span>${l.localizacao || 'Não informado'}</span>
      <span class="status ${l.status === 'Disponível' ? 'disponivel' : 'indisponivel'}">${l.status}</span>
    `;
    lista.appendChild(div);
  });
}

// ========================== FILTROS ========================== //
function filtrarLivros() {
  const termo = document.getElementById('busca').value.toLowerCase();
  const statusFiltro = document.getElementById('filtroStatus').value;
  const generoFiltro = document.getElementById('filtroGenero').value;
  livrosFiltrados = dadosCompletos.filter(l => {
    const correspondeTermo =
      (l.titulo && l.titulo.toLowerCase().includes(termo)) ||
      (l.autor && l.autor.toLowerCase().includes(termo)) ||
      (l.genero && l.genero.toLowerCase().includes(termo)) ||
      (l.localizacao && l.localizacao.toLowerCase().includes(termo));
    const correspondeStatus = statusFiltro === 'todos' || l.status === statusFiltro;
    const correspondeGenero = generoFiltro === 'todos' || l.genero === generoFiltro;
    return correspondeTermo && correspondeStatus && correspondeGenero;
  });
  calcularTotalPaginas();
  PAGINACAO_CONFIG.paginaAtual = 1;
  renderizarLivros();
  atualizarControlesPaginacao();
}

function extrairGeneros() {
  const generosSet = new Set();
  dadosCompletos.forEach(l => {
    if (l.genero && l.genero.trim() !== '') generosSet.add(l.genero);
  });
  const filtroGenero = document.getElementById('filtroGenero');
  while (filtroGenero.options.length > 1) filtroGenero.remove(1);
  Array.from(generosSet).sort().forEach(g => {
    const opt = document.createElement('option');
    opt.value = g;
    opt.textContent = g;
    filtroGenero.appendChild(opt);
  });
}

// ========================== CARREGAMENTO ========================== //
async function carregarDadosRemotos() {
  const url = `${URL_JSON}?t=${new Date().getTime()}`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error('Erro ao baixar dados');
  return await resp.json();
}

async function carregarDados() {
  let dados = null;
  if (isCacheValid()) {
    dados = recuperarDoCache();
  }
  if (!dados) {
    try {
      dados = await carregarDadosRemotos();
      salvarNoCache(dados);
    } catch(e) {
      console.error('Falha ao carregar dados remotos', e);
      dados = recuperarDoCache() || { livros: [] };
    }
  }
  dadosCompletos = dados.livros || [];
  livrosFiltrados = [...dadosCompletos];
  document.getElementById('total-livros').textContent = dadosCompletos.length;
  document.getElementById('total-disponiveis').textContent = dadosCompletos.filter(l => l.status==='Disponível').length;
  extrairGeneros();
  calcularTotalPaginas();
  renderizarLivros();
  atualizarControlesPaginacao();
}

// ========================== EVENTOS ========================== //
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('busca').addEventListener('input', filtrarLivros);
  document.getElementById('filtroStatus').addEventListener('change', filtrarLivros);
  document.getElementById('filtroGenero').addEventListener('change', filtrarLivros);
  carregarDados();
});
</script>

</body>
</html>
